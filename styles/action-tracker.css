/* ============================================================
   ECHOES OF BAPHOMET — ACTION TRACKER CSS v1.2
   Gaslamp Gothic | Burnt brass, cold iron, dried blood.
   No neon. No outer glow. Physical insets only.

   Visual Language:
   ◆ Tarnished Gold  = Action (available)          #b8943e
   ◆ Verdigris       = Reaction (available)         #4b7a7a
   ◆ Cold Iron       = Combat Reflexes AoO-only     #3a5a78
   ◆ Ash             = Spent (shard-burnt, gone)
   ◆ Dried Blood     = Condition-locked (taken)     #5e1b14
   ============================================================ */

/* --- shardBurn keyframes ---
   Pip briefly flares dull red then collapses to ash.
   Abrupt. Like a candle snuffed with a wet thumb. */
@keyframes shardBurn {
  0%   { transform: scale(1);    background-color: inherit; }
  15%  { transform: scale(0.75); background-color: var(--baph-red, #5e1b14); opacity: 0.9; }
  35%  { transform: scale(0.85); background-color: #3a1410; }
  60%  { transform: scale(0.92); background-color: #1e0e0c; }
  100% { transform: scale(1);
         background: radial-gradient(circle at 40% 35%, #1e1614, #0e0a09);
         opacity: 0.28; }
}

/* ============================================================
   COMBATANT ROW LAYOUT FIX
   [DIRECTIVE: UI BUG]

   Problem: .baph-action-tracker was injected inline with HP
   and Initiative, pushing the initiative score off-screen.

   Fix (CSS side): The combatant row must allow the pip bar
   to stack BELOW the name/stats line, not sit beside it.

   The JS injection point places the pip row AFTER .token-name
   or .combatant-name. These selectors ensure the combatant's
   flex layout wraps or stacks the pip row below.

   We force the combatant entry to be a flex column, then let
   the name/resource row and the pip row stack vertically.
   ============================================================ */

/* Force the combatant li to stack vertically */
#combat-tracker .combatant,
#combat-tracker li.combatant {
  display: flex;
  flex-direction: column;
  align-items: stretch;
}

/* The existing top row (avatar + name + resource + initiative)
   stays horizontal within its own wrapper */
#combat-tracker .combatant .combatant-control,
#combat-tracker .combatant .token-name,
#combat-tracker .combatant .token-resource,
#combat-tracker .combatant .token-initiative {
  /* These elements are siblings inside the flex-column combatant.
     We do NOT override their own display — just ensure they don't
     cause the pip bar to flow beside them. */
}

/* --- Pip Row Container ---
   Full-width block beneath the name row.
   Never inline. Never pushes initiative off-screen. */
.baph-action-tracker {
  display: flex;
  flex-direction: row;
  flex-wrap: nowrap;
  gap: 4px;
  align-items: center;
  padding: 2px 6px 3px;
  margin: 0;         /* flush to the name row above */
  width: 100%;
  min-height: 18px;
  box-sizing: border-box;
  user-select: none;
  /* Stamped iron tray — hard inset, no outer glow */
  border-top: 1px solid rgba(184, 148, 62, 0.15);
  box-shadow: inset 0 2px 4px rgba(0, 0, 0, 0.5);
  background: rgba(14, 12, 11, 0.55);
}

/* --- Base Pip --- */
.baph-pip {
  width: 13px;
  height: 13px;
  border-radius: 1px;   /* slightly square — less digital */
  cursor: pointer;
  border: 1px solid rgba(255, 255, 255, 0.07);
  /* Stamped coin — physical relief */
  box-shadow: inset 0 1px 2px rgba(0, 0, 0, 0.45),
              inset 0 -1px 1px rgba(255,255,255,0.03);
  flex-shrink: 0;

  /* SHARP snap for normal state transitions */
  transition: background-color 0.05s step-end,
              opacity 0.05s step-end,
              border-color 0.05s step-end,
              box-shadow 0.05s step-end;
}

.baph-pip:hover {
  border-color: rgba(255, 255, 255, 0.2);
  filter: brightness(1.12);
}

/* --- Action Pips (Tarnished Gold) --- */
.baph-pip.action {
  background-color: var(--baph-gold, #b8943e);
  border-color: rgba(184, 148, 62, 0.35);
}

/* --- Reaction Pip (Verdigris / Oxidised Copper) --- */
.baph-pip.reaction {
  background-color: #4b7a7a;
  border-color: rgba(75, 122, 122, 0.35);
}

/* --- Combat Reflexes Pip (Dull Cold Iron) --- */
.baph-pip.combat-reflex {
  background-color: #3a5a78;
  border-color: rgba(58, 90, 120, 0.35);
}

/* --- SPENT STATE ---
   Triggers shardBurn, holds at ash. */
.baph-pip.spent {
  animation: shardBurn 0.35s ease-out forwards;
  background: radial-gradient(circle at 40% 35%, #1e1614, #0e0a09);
  opacity: 0.28;
  border-color: rgba(255, 255, 255, 0.02);
  box-shadow: none;
  cursor: default;
}

.baph-pip.spent:hover {
  opacity: 0.40;
  border-color: rgba(255, 255, 255, 0.06);
  filter: none;
}

/* --- CONDITION-LOCKED STATE ---
   Dried blood. Not spent — taken.
   Hard border. No animation. No recovery. */
.baph-pip.condition-locked {
  background-color: var(--baph-danger, #5e1b14);
  opacity: 0.65;
  border-color: rgba(94, 27, 20, 0.5);
  /* Hard inset — stamped wound, not a glow */
  box-shadow: inset 0 1px 3px rgba(0, 0, 0, 0.6),
              inset 0 0 2px rgba(94, 27, 20, 0.4);
  cursor: not-allowed;
  transition: none;
}

.baph-pip.condition-locked:hover {
  filter: none;
  border-color: rgba(94, 27, 20, 0.7);
}

/* --- Separator between Actions and Reactions --- */
.baph-pip-separator {
  width: 1px;
  height: 11px;
  background-color: rgba(255, 255, 255, 0.08);
  margin: 0 1px;
  flex-shrink: 0;
}

/* --- Active Combatant Highlight ---
   Embers of the active turn. Physical warmth — no outer glow.
   Inset light only, simulating candlelight from within. */
.combatant.active .baph-action-tracker .baph-pip.action:not(.spent):not(.condition-locked) {
  box-shadow: inset 0 1px 2px rgba(0, 0, 0, 0.3),
              inset 0 -1px 0 rgba(255, 255, 255, 0.04);
  border-color: rgba(184, 148, 62, 0.55);
}

.combatant.active .baph-action-tracker .baph-pip.reaction:not(.spent) {
  box-shadow: inset 0 1px 2px rgba(0, 0, 0, 0.3),
              inset 0 -1px 0 rgba(255, 255, 255, 0.03);
  border-color: rgba(75, 122, 122, 0.55);
}

.combatant.active .baph-action-tracker .baph-pip.combat-reflex:not(.spent) {
  box-shadow: inset 0 1px 2px rgba(0, 0, 0, 0.3),
              inset 0 -1px 0 rgba(255, 255, 255, 0.03);
  border-color: rgba(58, 90, 120, 0.55);
}
